<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PUBG MONTAGE PRO - المشروع الجامعي</title>
    <!-- Tailwind CSS مع دعم RTL -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FFmpeg.wasm -->
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <!-- Font Awesome للأيقونات -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* تخصيص شريط التمرير */
        input[type=range] {
            @apply appearance-none bg-transparent;
        }
        input[type=range]::-webkit-slider-runnable-track {
            @apply bg-gray-700 h-2 rounded-full;
        }
        input[type=range]::-webkit-slider-thumb {
            @apply appearance-none w-5 h-5 bg-cyan-400 rounded-full mt-[-4px] shadow-lg border-2 border-white;
        }
        input[type=range]::-moz-range-track {
            @apply bg-gray-700 h-2 rounded-full;
        }
        input[type=range]::-moz-range-thumb {
            @apply w-5 h-5 bg-cyan-400 rounded-full border-2 border-white;
        }
        /* شريط التقدم */
        .progress-bar {
            @apply h-2 bg-gray-700 rounded-full overflow-hidden;
        }
        .progress-fill {
            @apply h-full bg-gradient-to-l from-cyan-400 to-blue-600 transition-all duration-300;
        }
        /* بطاقات التأثيرات */
        .effect-card {
            @apply bg-gray-800/50 p-4 rounded-2xl border border-white/5 hover:border-cyan-500/30 transition-all;
        }
    </style>
</head>
<body class="bg-gradient-to-b from-[#0a0c12] to-[#030405] text-white font-sans min-h-screen">

    <!-- رأس الصفحة -->
    <header class="text-center py-8">
        <h1 class="text-5xl md:text-7xl font-black tracking-tighter bg-clip-text text-transparent bg-gradient-to-l from-cyan-300 to-blue-700 drop-shadow-[0_0_20px_rgba(6,182,212,0.5)]">
            PUBG MONTAGE PRO
        </h1>
        <p class="text-gray-500 text-sm tracking-widest mt-2">مشروع تخرج 2025 - محرر الفيديو الاحترافي</p>
    </header>

    <main class="container mx-auto px-4 pb-12 max-w-6xl">
        <!-- منطقة رفع الفيديو والمعاينة -->
        <div class="bg-gray-900/60 backdrop-blur-sm rounded-3xl p-6 border border-white/10 shadow-2xl mb-8">
            <div id="dropZone" class="relative border-2 border-dashed border-gray-700 hover:border-cyan-500/50 rounded-2xl p-8 text-center cursor-pointer transition-all min-h-[300px] flex items-center justify-center bg-black/20">
                <input type="file" id="videoInput" accept="video/*" class="hidden">
                <div id="uploadUI" class="space-y-4">
                    <div class="w-24 h-24 mx-auto bg-cyan-500/10 rounded-full flex items-center justify-center border border-cyan-500/30">
                        <i class="fas fa-cloud-upload-alt text-4xl text-cyan-400"></i>
                    </div>
                    <p class="text-2xl font-bold">اسحب الفيديو أو اضغط للرفع</p>
                    <p class="text-gray-500">mp4, mov, avi - حتى 100 ميجابايت</p>
                </div>
                <div id="previewContainer" class="hidden w-full relative">
                    <video id="previewVideo" class="w-full max-h-[400px] rounded-xl shadow-2xl" controls playsinline></video>
                    <button onclick="document.getElementById('videoInput').click()" class="absolute -top-3 -left-3 bg-red-600 p-3 rounded-full shadow-xl hover:scale-110 transition">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- لوحة التحكم (تظهر بعد رفع الفيديو) -->
        <div id="controlPanel" class="hidden space-y-6">
            <!-- خيارات القص والسرعة -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- قص الفيديو -->
                <div class="effect-card">
                    <h3 class="font-bold text-lg mb-3 flex items-center gap-2"><i class="fas fa-cut text-cyan-400"></i> قص المقطع</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">البداية (ثواني)</label>
                            <input type="range" id="trimStart" min="0" max="100" step="0.1" value="0" class="w-full">
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span id="startTimeDisplay">0.0</span>
                                <span>المدة الكلية: <span id="totalDuration">0</span> ث</span>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">النهاية (ثواني)</label>
                            <input type="range" id="trimEnd" min="0" max="100" step="0.1" value="100" class="w-full">
                            <div class="text-left text-xs text-gray-500 mt-1" id="endTimeDisplay">100.0</div>
                        </div>
                    </div>
                </div>
                <!-- سرعة الفيديو -->
                <div class="effect-card">
                    <h3 class="font-bold text-lg mb-3 flex items-center gap-2"><i class="fas fa-tachometer-alt text-yellow-400"></i> السرعة</h3>
                    <div>
                        <input type="range" id="speed" min="0.5" max="2.5" step="0.1" value="1.0" class="w-full">
                        <div class="flex justify-between text-sm mt-2">
                            <span>0.5x</span>
                            <span id="speedValue" class="font-bold text-cyan-300">1.0x</span>
                            <span>2.5x</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- تأثيرات الألوان -->
            <div class="effect-card">
                <h3 class="font-bold text-lg mb-3 flex items-center gap-2"><i class="fas fa-palette text-purple-400"></i> تأثيرات الألوان</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">الحدّة</label>
                        <input type="range" id="sharpness" min="0" max="3" step="0.1" value="1.5" class="w-full">
                        <span id="sharpVal" class="text-xs text-cyan-400">1.5</span>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">التشبع</label>
                        <input type="range" id="saturation" min="0" max="3" step="0.1" value="1.5" class="w-full">
                        <span id="satVal" class="text-xs text-yellow-400">1.5</span>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">السطوع</label>
                        <input type="range" id="brightness" min="0.5" max="1.5" step="0.01" value="1.0" class="w-full">
                        <span id="brightVal" class="text-xs text-purple-400">1.0</span>
                    </div>
                </div>
                <!-- بريسيتات سريعة -->
                <div class="flex flex-wrap gap-2 mt-4">
                    <button onclick="applyPreset('vibrant')" class="px-4 py-2 bg-cyan-600/20 rounded-xl text-sm hover:bg-cyan-600/40 transition">Vibrant</button>
                    <button onclick="applyPreset('sharp')" class="px-4 py-2 bg-cyan-600/20 rounded-xl text-sm hover:bg-cyan-600/40 transition">Ultra Sharp</button>
                    <button onclick="applyPreset('cinematic')" class="px-4 py-2 bg-cyan-600/20 rounded-xl text-sm hover:bg-cyan-600/40 transition">Cinematic</button>
                    <button onclick="applyPreset('reset')" class="px-4 py-2 bg-gray-700 rounded-xl text-sm hover:bg-gray-600 transition">إعادة ضبط</button>
                </div>
            </div>

            <!-- خيارات التصدير -->
            <div class="effect-card">
                <h3 class="font-bold text-lg mb-3 flex items-center gap-2"><i class="fas fa-cog text-green-400"></i> إعدادات التصدير</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <label class="flex items-center gap-2 p-2 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700">
                        <input type="radio" name="quality" value="1080p" class="accent-cyan-400"> 1080p
                    </label>
                    <label class="flex items-center gap-2 p-2 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700">
                        <input type="radio" name="quality" value="720p" checked class="accent-cyan-400"> 720p
                    </label>
                    <label class="flex items-center gap-2 p-2 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700">
                        <input type="radio" name="quality" value="480p" class="accent-cyan-400"> 480p
                    </label>
                    <label class="flex items-center gap-2 p-2 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700">
                        <input type="radio" name="quality" value="360p" class="accent-cyan-400"> 360p
                    </label>
                </div>
                <div class="mt-3 text-xs text-gray-400">
                    * الجودة العالية تستهلك ذاكرة أكبر. اختر 720p أو أقل لمقاطع طويلة.
                </div>
            </div>

            <!-- زر المعالجة -->
            <button id="processBtn" class="w-full py-5 bg-gradient-to-l from-cyan-500 to-blue-600 rounded-2xl font-black text-xl tracking-widest hover:shadow-[0_0_30px_rgba(6,182,212,0.6)] transition-all disabled:opacity-50">
                <i class="fas fa-magic ml-2"></i> ابدأ المعالجة الآن
            </button>
        </div>

        <!-- شاشة التقدم -->
        <div id="progressContainer" class="hidden mt-8 bg-gray-900/60 backdrop-blur-sm rounded-2xl p-6 border border-cyan-500/30">
            <div class="flex justify-between items-center mb-3">
                <span class="font-bold text-cyan-400"><i class="fas fa-spinner fa-pulse ml-2"></i> جاري المعالجة...</span>
                <span id="progressPercent" class="font-mono text-cyan-400">0%</span>
            </div>
            <div class="progress-bar">
                <div id="progressBar" class="progress-fill" style="width:0%"></div>
            </div>
            <p class="text-gray-500 text-xs mt-4 text-center">لا تغلق الصفحة. قد تستغرق العملية دقيقة أو اثنتين حسب طول الفيديو.</p>
        </div>

        <!-- النتيجة النهائية -->
        <div id="resultContainer" class="hidden mt-8 bg-gray-900/60 backdrop-blur-sm rounded-2xl p-6 border border-green-500/30">
            <div class="flex items-center gap-3 text-green-400 mb-4">
                <i class="fas fa-check-circle text-2xl"></i>
                <span class="font-bold">تم التجهيز بنجاح!</span>
            </div>
            <video id="outputVideo" controls playsinline class="w-full rounded-xl shadow-2xl mb-4"></video>
            <div id="outputFileSize" class="text-sm text-gray-400 mb-4 text-center"></div>
            <div class="grid grid-cols-2 gap-4">
                <button id="downloadBtn" class="btn-download bg-gradient-to-l from-cyan-500 to-blue-600 py-4 rounded-xl font-bold hover:shadow-lg transition">
                    <i class="fas fa-download ml-2"></i> تحميل الفيديو
                </button>
                <button id="emergencyBtn" class="btn-download bg-orange-600 py-4 rounded-xl font-bold hover:bg-orange-700 transition">
                    <i class="fas fa-exclamation-triangle ml-2"></i> تحميل بجودة منخفضة (طوارئ)
                </button>
            </div>
        </div>
    </main>

    <script>
        // استدعاء FFmpeg
        const { createFFmpeg, fetchFile } = FFmpeg;
        const ffmpeg = createFFmpeg({ 
            log: false,
            corePath: 'https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js'
        });

        // عناصر DOM
        const videoInput = document.getElementById('videoInput');
        const dropZone = document.getElementById('dropZone');
        const uploadUI = document.getElementById('uploadUI');
        const previewContainer = document.getElementById('previewContainer');
        const previewVideo = document.getElementById('previewVideo');
        const controlPanel = document.getElementById('controlPanel');
        const processBtn = document.getElementById('processBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressPercent = document.getElementById('progressPercent');
        const resultContainer = document.getElementById('resultContainer');
        const outputVideo = document.getElementById('outputVideo');
        const downloadBtn = document.getElementById('downloadBtn');
        const emergencyBtn = document.getElementById('emergencyBtn');
        const outputFileSize = document.getElementById('outputFileSize');

        // متغيرات عامة
        let videoFile = null;
        let videoDuration = 0;
        let outputBlob = null;
        let outputUrl = null;

        // أحداث رفع الفيديو
        dropZone.addEventListener('click', (e) => {
            if (e.target.tagName !== 'VIDEO' && e.target.tagName !== 'BUTTON') videoInput.click();
        });

        videoInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                videoFile = file;
                const url = URL.createObjectURL(file);
                previewVideo.src = url;
                previewContainer.classList.remove('hidden');
                uploadUI.classList.add('hidden');
                controlPanel.classList.remove('hidden');
                // الحصول على مدة الفيديو
                previewVideo.addEventListener('loadedmetadata', () => {
                    videoDuration = previewVideo.duration;
                    document.getElementById('totalDuration').innerText = videoDuration.toFixed(1);
                    // ضبط أقصى قيمة لشرائط القص
                    document.getElementById('trimStart').max = videoDuration;
                    document.getElementById('trimEnd').max = videoDuration;
                    document.getElementById('trimEnd').value = videoDuration;
                    document.getElementById('endTimeDisplay').innerText = videoDuration.toFixed(1);
                });
                // تحديث الفلاتر على المعاينة
                updatePreviewFilters();
            }
        });

        // تحديث المعاينة بالفلاتر (تأثيرات الألوان)
        function updatePreviewFilters() {
            const sharp = document.getElementById('sharpness').value;
            const sat = document.getElementById('saturation').value;
            const bright = document.getElementById('brightness').value;
            previewVideo.style.filter = `saturate(${sat}) brightness(${bright}) contrast(${1 + sharp*0.2})`;
        }

        // تحديث قيم الشرائط
        document.getElementById('sharpness').addEventListener('input', (e) => {
            document.getElementById('sharpVal').innerText = e.target.value;
            updatePreviewFilters();
        });
        document.getElementById('saturation').addEventListener('input', (e) => {
            document.getElementById('satVal').innerText = e.target.value;
            updatePreviewFilters();
        });
        document.getElementById('brightness').addEventListener('input', (e) => {
            document.getElementById('brightVal').innerText = e.target.value;
            updatePreviewFilters();
        });
        document.getElementById('speed').addEventListener('input', (e) => {
            document.getElementById('speedValue').innerText = e.target.value + 'x';
        });
        document.getElementById('trimStart').addEventListener('input', (e) => {
            document.getElementById('startTimeDisplay').innerText = parseFloat(e.target.value).toFixed(1);
        });
        document.getElementById('trimEnd').addEventListener('input', (e) => {
            document.getElementById('endTimeDisplay').innerText = parseFloat(e.target.value).toFixed(1);
        });

        // بريسيتات الألوان
        window.applyPreset = function(type) {
            const sharp = document.getElementById('sharpness');
            const sat = document.getElementById('saturation');
            const bright = document.getElementById('brightness');
            if (type === 'vibrant') {
                sharp.value = 1.2; sat.value = 2.0; bright.value = 1.1;
            } else if (type === 'sharp') {
                sharp.value = 2.5; sat.value = 1.4; bright.value = 1.0;
            } else if (type === 'cinematic') {
                sharp.value = 1.0; sat.value = 1.6; bright.value = 0.9;
            } else {
                sharp.value = 1.5; sat.value = 1.5; bright.value = 1.0;
            }
            // تحديث المعروض والتأثير
            ['sharpness','saturation','brightness'].forEach(id => {
                document.getElementById(id).dispatchEvent(new Event('input'));
            });
        };

        // معالجة الفيديو
        processBtn.addEventListener('click', async () => {
            if (!videoFile) return;

            // تعطيل الأزرار وإظهار التقدم
            processBtn.disabled = true;
            progressContainer.classList.remove('hidden');
            resultContainer.classList.add('hidden');
            progressBar.style.width = '0%';
            progressPercent.innerText = '0%';

            try {
                // تحميل ffmpeg إن لم يكن محملاً
                if (!ffmpeg.isLoaded()) await ffmpeg.load();

                ffmpeg.setProgress(({ ratio }) => {
                    const percent = Math.round(ratio * 100);
                    progressBar.style.width = percent + '%';
                    progressPercent.innerText = percent + '%';
                });

                // قراءة قيم التحكم
                const start = parseFloat(document.getElementById('trimStart').value);
                const end = parseFloat(document.getElementById('trimEnd').value);
                const speed = parseFloat(document.getElementById('speed').value);
                const sharp = parseFloat(document.getElementById('sharpness').value);
                const sat = parseFloat(document.getElementById('saturation').value);
                const bright = parseFloat(document.getElementById('brightness').value) - 1.0; // تعديل للـ eq

                // جودة التصدير
                const quality = document.querySelector('input[name="quality"]:checked').value;
                let scale, crf, bitrate;
                if (quality === '1080p') { scale = '1920:1080'; crf = '28'; bitrate = '3M'; }
                else if (quality === '720p') { scale = '1280:720'; crf = '30'; bitrate = '2M'; }
                else if (quality === '480p') { scale = '854:480'; crf = '32'; bitrate = '1M'; }
                else { scale = '640:360'; crf = '35'; bitrate = '800k'; }

                // حساب مدة القطع
                const duration = end - start;
                const trimStart = start;

                // إعداد الفلتر المركب
                // نستخدم setpts لتغيير السرعة، unsharp و eq للألوان
                const filter = `scale=${scale},setpts=${1/speed}*PTS,unsharp=5:5:${sharp}:5:5:0,eq=saturation=${sat}:brightness=${bright}`;

                // كتابة الملف المدخل في نظام FFmpeg
                const inputName = 'input.mp4';
                const outputName = 'output.mp4';
                ffmpeg.FS('writeFile', inputName, await fetchFile(videoFile));

                // أوامر FFmpeg: قص (ss و t) ثم تطبيق الفلاتر
                await ffmpeg.run(
                    '-i', inputName,
                    '-ss', trimStart.toString(),
                    '-t', duration.toString(),
                    '-vf', filter,
                    '-c:v', 'libx264',
                    '-crf', crf,
                    '-b:v', bitrate,
                    '-preset', 'ultrafast',
                    '-movflags', '+faststart',
                    '-c:a', 'aac', // إعادة ترميز الصوت ليتناسب مع السرعة
                    '-b:a', '128k',
                    outputName
                );

                // قراءة النتيجة
                const data = ffmpeg.FS('readFile', outputName);
                outputBlob = new Blob([data.buffer], { type: 'video/mp4' });

                // تنظيف
                ffmpeg.FS('unlink', inputName);
                ffmpeg.FS('unlink', outputName);

                // إنشاء رابط للمعاينة
                if (outputUrl) URL.revokeObjectURL(outputUrl);
                outputUrl = URL.createObjectURL(outputBlob);
                outputVideo.src = outputUrl;

                // عرض حجم الملف
                const sizeMB = (outputBlob.size / (1024 * 1024)).toFixed(2);
                outputFileSize.innerHTML = `حجم الملف: ${sizeMB} ميجابايت`;
                if (outputBlob.size > 100 * 1024 * 1024) {
                    outputFileSize.innerHTML += ' ⚠️ كبير جداً، استخدم زر الطوارئ إن لم يحفظ.';
                }

                // إظهار النتيجة
                resultContainer.classList.remove('hidden');
                progressContainer.classList.add('hidden');
                processBtn.disabled = false;

            } catch (err) {
                console.error(err);
                alert('حدث خطأ أثناء المعالجة. جرب جودة أقل أو فيديو أقصر.');
                progressContainer.classList.add('hidden');
                processBtn.disabled = false;
            }
        });

        // تحميل عادي
        downloadBtn.addEventListener('click', () => {
            if (!outputBlob) return;
            const a = document.createElement('a');
            a.href = outputUrl;
            a.download = 'PUBG_MONTAGE.mp4';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        });

        // تحميل طوارئ (ضغط إضافي)
        emergencyBtn.addEventListener('click', async () => {
            if (!outputBlob) return;
            emergencyBtn.disabled = true;
            emergencyBtn.innerHTML = '<i class="fas fa-spinner fa-pulse ml-2"></i> جاري الضغط...';

            try {
                if (!ffmpeg.isLoaded()) await ffmpeg.load();

                const inputName = 'emergency_in.mp4';
                const outputName = 'emergency_out.mp4';
                ffmpeg.FS('writeFile', inputName, await fetchFile(new File([outputBlob], 'temp.mp4')));

                // ضغط قوي جداً
                await ffmpeg.run(
                    '-i', inputName,
                    '-c:v', 'libx264',
                    '-crf', '42',
                    '-b:v', '500k',
                    '-preset', 'ultrafast',
                    '-vf', 'scale=480:360',
                    '-c:a', 'aac',
                    '-b:a', '64k',
                    '-movflags', '+faststart',
                    outputName
                );

                const data = ffmpeg.FS('readFile', outputName);
                const compressedBlob = new Blob([data.buffer], { type: 'video/mp4' });

                ffmpeg.FS('unlink', inputName);
                ffmpeg.FS('unlink', outputName);

                // تحميل الملف المضغوط
                const url = URL.createObjectURL(compressedBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'PUBG_MONTAGE_LOW.mp4';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                setTimeout(() => URL.revokeObjectURL(url), 100);

            } catch (e) {
                console.error(e);
                alert('فشل الضغط الإضافي. حاول مرة أخرى.');
            } finally {
                emergencyBtn.disabled = false;
                emergencyBtn.innerHTML = '<i class="fas fa-exclamation-triangle ml-2"></i> تحميل بجودة منخفضة (طوارئ)';
            }
        });
    </script>
</body>
</html>
