<!DOCTYPE html>
<html lang="ar" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>بث شاشة ببجي | لينوفو</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@900&display=swap');
        body { font-family: 'Noto Sans Arabic', sans-serif; background: #000; color: #fff; height: 100vh; overflow: hidden; }
        .screen-btn { 
            background: #ef4444; 
            border-radius: 24px; 
            box-shadow: 0 0 30px rgba(239, 68, 68, 0.5); 
            transition: 0.3s;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 20px rgba(239, 68, 68, 0.4); }
            50% { transform: scale(1.02); box-shadow: 0 0 40px rgba(239, 68, 68, 0.7); }
            100% { transform: scale(1); box-shadow: 0 0 20px rgba(239, 68, 68, 0.4); }
        }
        #remote-video { width: 100vw; height: 100vh; background: #000; object-fit: contain; }
    </style>
</head>
<body class="flex flex-col items-center justify-center p-4">

    <!-- اختيار الدور -->
    <div id="selection-view" class="space-y-8 w-full max-w-sm text-center">
        <h1 class="text-4xl font-black italic tracking-tighter text-red-500">PUBG <span class="text-white">ULTIMATE</span></h1>
        <p class="text-zinc-500 text-sm">محاولة أخيرة لتجاوز قيود نظام لينوفو</p>
        
        <div class="flex flex-col gap-4">
            <button onclick="setupPC()" class="bg-zinc-900 p-6 rounded-3xl border border-zinc-700 font-bold">جهاز الاستقبال (البي سي)</button>
            <button onclick="setupTablet()" class="bg-zinc-900 p-6 rounded-3xl border border-zinc-700 font-bold text-red-400 border-red-500/30">جهاز اللعب (التابلت)</button>
        </div>
    </div>

    <!-- واجهة البي سي -->
    <div id="pc-view" class="hidden text-center space-y-6">
        <div id="qrcode" class="p-4 bg-white rounded-3xl inline-block shadow-2xl border-4 border-red-500"></div>
        <p class="font-bold text-red-500">امسح الكود بالتابلت الآن</p>
    </div>

    <!-- واجهة التابلت -->
    <div id="tablet-view" class="hidden w-full max-w-sm space-y-8 text-center">
        <div class="bg-red-900/20 border border-red-500/30 p-5 rounded-3xl text-xs text-red-300 leading-relaxed">
            <b>تحذير التجاوز:</b><br>
            إذا ضغطت الزر ولم تظهر نافذة "البدء الآن"، فجهازك يمنع المتصفحات تماماً من البث. تأكد من إغلاق أي تطبيقات أخرى تسجل الشاشة.
        </div>

        <button id="start-screen-btn" class="screen-btn w-full py-8 font-black text-2xl uppercase tracking-widest">
            تنشيط البث الإجباري
        </button>

        <div class="space-y-2 text-[10px] text-zinc-600">
            <p>1. افتح الرابط في Google Chrome حصراً</p>
            <p>2. فعل "Desktop Site" من النقاط الثلاث</p>
            <p>3. تأكد من إلغاء "وضع توفير الطاقة"</p>
        </div>
    </div>

    <!-- العرض المباشر (PC) -->
    <div id="live-view" class="hidden fixed inset-0 bg-black flex items-center justify-center">
        <video id="remote-video" autoplay playsinline muted></video>
        <button id="play-btn" class="absolute bg-red-600 px-8 py-3 rounded-full font-bold hidden" onclick="$('remote-video').play(); this.classList.add('hidden');">اضغط هنا لفتح البث</button>
    </div>

    <script>
        let peer;
        const $ = id => document.getElementById(id);

        function setupPC() {
            $('selection-view').classList.add('hidden');
            $('pc-view').classList.remove('hidden');
            peer = new Peer();
            peer.on('open', id => {
                const url = window.location.href.split('?')[0] + "?sid=" + id;
                new QRCode($("qrcode"), { text: url, width: 220, height: 220 });
            });
            peer.on('call', call => {
                call.answer();
                call.on('stream', stream => {
                    $('pc-view').classList.add('hidden');
                    $('live-view').classList.remove('hidden');
                    const video = $('remote-video');
                    video.srcObject = stream;
                    video.onloadedmetadata = () => {
                        video.play().catch(() => $('play-btn').classList.remove('hidden'));
                    };
                });
            });
        }

        async function setupTablet() {
            const sid = new URLSearchParams(window.location.search).get('sid');
            if (!sid) return alert("يرجى مسح الكود أولاً!");

            $('selection-view').classList.add('hidden');
            $('tablet-view').classList.remove('hidden');

            $('start-screen-btn').onclick = async () => {
                try {
                    // إجبار المتصفح على طلب الشاشة بأقصى إعدادات
                    const screenStream = await navigator.mediaDevices.getDisplayMedia({
                        video: { 
                            displaySurface: "monitor",
                            frameRate: 60
                        },
                        audio: true
                    });

                    peer = new Peer();
                    peer.on('open', () => {
                        const call = peer.call(sid, screenStream);
                        $('start-screen-btn').innerText = "تم الاتصال! ادخل ببجي الآن";
                        $('start-screen-btn').classList.replace('bg-red-600', 'bg-green-600');
                    });

                    screenStream.getVideoTracks()[0].onended = () => location.reload();

                } catch (e) {
                    alert("للأسف، تابلت لينوفو يرفض البث من المتصفح. \n\nالحل الوحيد المتبقي هو تحميل تطبيق 'Screen Stream over HTTP' من متجر Play.");
                }
            };
        }

        window.onload = () => {
            if (window.location.search.includes('sid')) setupTablet();
        };
    </script>
</body>
</html>
