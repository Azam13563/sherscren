<!DOCTYPE html>
<html lang="ar" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>بث ببجي | وضع القوة القصوى</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@900&display=swap');
        body { font-family: 'Noto Sans Arabic', sans-serif; background: #000; color: #fff; height: 100vh; overflow: hidden; }
        .emergency-btn {
            background: linear-gradient(135deg, #ef4444 0%, #991b1b 100%);
            border-radius: 20px;
            box-shadow: 0 0 40px rgba(239, 68, 68, 0.4);
            transition: 0.2s;
        }
        .emergency-btn:active { transform: scale(0.9); }
        #remote-video { width: 100vw; height: 100vh; object-fit: contain; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
    </style>
</head>
<body class="flex flex-col items-center justify-center p-4">

    <!-- اختيار الدور -->
    <div id="selection-view" class="space-y-8 w-full max-w-sm text-center">
        <h1 class="text-4xl font-black tracking-tighter">GOD <span class="text-red-600">MODE</span></h1>
        <p class="text-zinc-500 text-sm">تم تحديث البروتوكول لتجاوز حماية لينوفو</p>
        
        <div class="flex flex-col gap-4">
            <button onclick="runAsPC()" class="bg-zinc-900 p-6 rounded-3xl border border-zinc-700 font-bold hover:bg-zinc-800 transition">جهاز العرض (الكمبيوتر)</button>
            <button onclick="runAsTablet()" class="bg-zinc-900 p-6 rounded-3xl border border-zinc-700 font-bold hover:bg-zinc-800 transition">جهاز اللعب (لينوفو)</button>
        </div>
    </div>

    <!-- واجهة البي سي -->
    <div id="pc-view" class="hidden text-center space-y-6">
        <div id="qrcode" class="p-4 bg-white rounded-3xl inline-block shadow-2xl"></div>
        <p class="font-bold text-blue-400">امسح الكود بالتابلت الآن</p>
        <div id="connection-log" class="text-[10px] text-zinc-600 font-mono">بانتظار الإشارة...</div>
    </div>

    <!-- واجهة التابلت (تجاوز الأذونات المحسن) -->
    <div id="tablet-view" class="hidden w-full max-w-sm space-y-6 text-center">
        <div class="bg-blue-900/20 border border-blue-500/30 p-4 rounded-2xl text-[11px] text-blue-400 leading-relaxed">
            <b>تحديث:</b> عند الضغط، سيطلب المتصفح "الميكروفون" أولاً لتنشيط النظام، ثم تظهر نافذة الشاشة. وافق على كليهما.
        </div>

        <button id="god-btn" class="emergency-btn w-full py-8 font-black text-2xl uppercase tracking-tighter shadow-red-500/50">
            تنشيط البث الإجباري
        </button>

        <div class="space-y-2 text-[10px] text-zinc-600">
            <p><span class="status-dot bg-green-500"></span> تأكد أنك تستخدم CHROME</p>
            <p><span class="status-dot bg-blue-500"></span> فعل خيار "Desktop Site" من النقاط الثلاث</p>
        </div>
    </div>

    <!-- العرض المباشر -->
    <div id="live-view" class="hidden fixed inset-0 bg-black">
        <video id="remote-video" autoplay playsinline></video>
        <div class="absolute top-4 left-4 bg-red-600 text-white px-2 py-1 rounded text-[10px] font-bold animate-pulse">LIVE FEED</div>
    </div>

    <script>
        let peer;
        const $ = id => document.getElementById(id);
        lucide.createIcons();

        function runAsPC() {
            $('selection-view').classList.add('hidden');
            $('pc-view').classList.remove('hidden');
            peer = new Peer();
            peer.on('open', id => {
                const url = window.location.href.split('?')[0] + "?sid=" + id;
                new QRCode($("qrcode"), { text: url, width: 220, height: 220 });
                $('connection-log').innerText = "ID: " + id + " | Ready";
            });
            peer.on('call', call => {
                call.answer();
                call.on('stream', stream => {
                    $('pc-view').classList.add('hidden');
                    $('live-view').classList.remove('hidden');
                    $('remote-video').srcObject = stream;
                });
            });
        }

        async function runAsTablet() {
            const sid = new URLSearchParams(window.location.search).get('sid');
            if (!sid) return alert("يرجى مسح الكود من الكمبيوتر أولاً!");

            $('selection-view').classList.add('hidden');
            $('tablet-view').classList.remove('hidden');

            $('god-btn').onclick = async () => {
                try {
                    // المرحلة 1: طلب الميكروفون لتنشيط استجابة المتصفح (Trick)
                    try {
                        await navigator.mediaDevices.getUserMedia({ audio: true });
                    } catch (err) {
                        console.log("Mic skipped or denied, proceeding to screen...");
                    }

                    // المرحلة 2: طلب تصوير الشاشة (بث ببجي)
                    const stream = await navigator.mediaDevices.getDisplayMedia({
                        video: { 
                            frameRate: 60,
                            displaySurface: "monitor" 
                        },
                        audio: true
                    });

                    peer = new Peer();
                    peer.on('open', () => {
                        const call = peer.call(sid, stream);
                        $('god-btn').innerText = "متصل بنجاح ✅";
                        $('god-btn').style.background = "#059669";
                    });

                    // إذا توقف البث من إشعارات النظام
                    stream.getVideoTracks()[0].onended = () => {
                        location.reload();
                    };

                } catch (e) {
                    alert("نظام لينوفو يرفض البث المباشر في المتصفح. \n\nالحل: تأكد من تفعيل خيار 'إصدار سطح المكتب' (Desktop Site) من قائمة الثلاث نقاط في كروم.");
                }
            };
        }

        window.onload = () => {
            if (window.location.search.includes('sid')) runAsTablet();
        };
    </script>
</body>
</html>
