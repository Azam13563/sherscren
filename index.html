<!DOCTYPE html>
<html lang="ar" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>إجبار أذونات لينوفو</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700&display=swap');
        body { font-family: 'Noto Sans Arabic', sans-serif; background: #000; color: #fff; margin: 0; height: 100vh; overflow: hidden; }
        .force-btn { background: linear-gradient(to right, #2563eb, #7c3aed); border-radius: 20px; transition: 0.3s; }
        .force-btn:active { transform: scale(0.9) rotate(1deg); }
        .step-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; }
    </style>
</head>
<body class="flex flex-col items-center justify-center p-6 text-center">

    <!-- شاشة الاختيار -->
    <div id="selection-view" class="space-y-8">
        <h1 class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">LENOVO FORCE</h1>
        <div class="flex flex-col gap-4">
            <button onclick="startPC()" class="step-card p-6 flex items-center justify-between">
                <span class="font-bold">المستقبل (البي سي)</span>
                <i data-lucide="monitor"></i>
            </button>
            <button onclick="startTablet()" class="step-card p-6 flex items-center justify-between">
                <span class="font-bold">المرسل (التابلت)</span>
                <i data-lucide="smartphone"></i>
            </button>
        </div>
    </div>

    <!-- واجهة البي سي -->
    <div id="pc-view" class="hidden space-y-6">
        <div id="qrcode" class="p-4 bg-white rounded-3xl inline-block shadow-2xl"></div>
        <p class="text-zinc-400">امسح الكود بتابلت لينوفو</p>
    </div>

    <!-- واجهة التابلت (المحاولة القسرية) -->
    <div id="tablet-view" class="hidden w-full max-w-sm space-y-6">
        <div class="p-4 bg-yellow-500/10 border border-yellow-500/30 rounded-2xl text-[11px] text-yellow-500 leading-relaxed">
            <b>تنبيه هام جداً:</b><br>
            بمجرد الضغط على الزر، سيطلب المتصفح "الكاميرا" أولاً، وافق عليها فوراً، ثم ستظهر نافذة "تسجيل الشاشة"، وافق عليها أيضاً.
        </div>

        <button id="force-btn" class="force-btn w-full py-6 font-black text-2xl shadow-2xl flex items-center justify-center gap-3">
            <i data-lucide="zap"></i>
            بدء البث القسري
        </button>

        <div class="text-[10px] text-zinc-500 mt-4">
            إذا فشل الأمر، الحل الوحيد هو تفعيل "وضع سطح المكتب" من إعدادات المتصفح.
        </div>
    </div>

    <!-- عرض مباشر (بي سي) -->
    <div id="live-view" class="hidden fixed inset-0 bg-black">
        <video id="remote-video" class="w-full h-full" autoplay playsinline></video>
    </div>

    <script>
        let peer;
        const $ = id => document.getElementById(id);
        lucide.createIcons();

        function startPC() {
            $('selection-view').classList.add('hidden');
            $('pc-view').classList.remove('hidden');
            peer = new Peer();
            peer.on('open', id => {
                const url = window.location.href.split('?')[0] + "?sid=" + id;
                new QRCode($("qrcode"), { text: url, width: 220, height: 220 });
            });
            peer.on('call', call => {
                call.answer();
                call.on('stream', stream => {
                    $('pc-view').classList.add('hidden');
                    $('live-view').classList.remove('hidden');
                    $('remote-video').srcObject = stream;
                });
            });
        }

        async function startTablet() {
            const sid = new URLSearchParams(window.location.search).get('sid');
            if (!sid) return alert("امسح الكود أولاً!");

            $('selection-view').classList.add('hidden');
            $('tablet-view').classList.remove('hidden');

            $('force-btn').onclick = async () => {
                try {
                    // المرحلة 1: طلب الكاميرا "لكسر" حماية النظام
                    const dummyStream = await navigator.mediaDevices.getUserMedia({ video: true }).catch(() => null);
                    
                    // المرحلة 2: طلب تصوير الشاشة (بث ببجي)
                    const screenStream = await navigator.mediaDevices.getDisplayMedia({
                        video: { frameRate: 60, width: { ideal: 1920 } },
                        audio: true
                    });

                    // إغلاق الكاميرا فوراً إذا كانت اشتغلت
                    if (dummyStream) dummyStream.getTracks().forEach(t => t.stop());

                    peer = new Peer();
                    peer.on('open', () => {
                        peer.call(sid, screenStream);
                        $('force-btn').innerText = "تم البث ✅";
                    });

                } catch (e) {
                    alert("المتصفح يرفض الطلب. اذهب للإعدادات > Chrome > الأذونات > وفعل 'تصوير الشاشة' يدوياً.");
                }
            };
        }

        window.onload = () => {
            if (window.location.search.includes('sid')) startTablet();
        };
    </script>
</body>
</html>
