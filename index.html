<!DOCTYPE html>
<html lang="ar" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>بث شاشة ببجي | لينوفو</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@900&display=swap');
        body { font-family: 'Noto Sans Arabic', sans-serif; background: #000; color: #fff; height: 100vh; overflow: hidden; }
        .screen-btn { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); border-radius: 24px; box-shadow: 0 10px 30px rgba(37, 99, 235, 0.4); transition: 0.3s; }
        .screen-btn:active { transform: scale(0.95); }
        #remote-video { width: 100vw; height: 100vh; background: #000; object-fit: contain; }
    </style>
</head>
<body class="flex flex-col items-center justify-center p-4">

    <!-- اختيار الدور -->
    <div id="selection-view" class="space-y-8 w-full max-w-sm text-center">
        <h1 class="text-4xl font-black italic tracking-tighter text-blue-500">PUBG <span class="text-white">MIRROR</span></h1>
        <p class="text-zinc-500 text-sm">هذا الإصدار مخصص لبث "الشاشة" فقط</p>
        
        <div class="flex flex-col gap-4">
            <button onclick="setupPC()" class="bg-zinc-900 p-6 rounded-3xl border border-zinc-700 font-bold">جهاز الاستقبال (البي سي)</button>
            <button onclick="setupTablet()" class="bg-zinc-900 p-6 rounded-3xl border border-zinc-700 font-bold text-blue-400 border-blue-500/30">جهاز اللعب (التابلت)</button>
        </div>
    </div>

    <!-- واجهة البي سي -->
    <div id="pc-view" class="hidden text-center space-y-6">
        <div id="qrcode" class="p-4 bg-white rounded-3xl inline-block shadow-2xl border-4 border-blue-500"></div>
        <p class="font-bold">امسح الكود بالتابلت للبدء</p>
    </div>

    <!-- واجهة التابلت -->
    <div id="tablet-view" class="hidden w-full max-w-sm space-y-8 text-center">
        <div class="bg-blue-900/20 border border-blue-500/30 p-5 rounded-3xl text-xs text-blue-300 leading-relaxed">
            <b>تنبيه هام جداً:</b><br>
            بمجرد الضغط على الزر، ستظهر رسالة من أندرويد تسألك عن "البدء الآن" لتصوير الشاشة. وافق عليها فوراً.
        </div>

        <button id="start-screen-btn" class="screen-btn w-full py-8 font-black text-2xl uppercase tracking-widest">
            بث الشاشة للبي سي
        </button>

        <p class="text-[10px] text-zinc-600">تأكد أنك تستخدم Chrome بوضع "موقع سطح المكتب"</p>
    </div>

    <!-- العرض المباشر (PC) -->
    <div id="live-view" class="hidden fixed inset-0 bg-black flex items-center justify-center">
        <video id="remote-video" autoplay playsinline></video>
        <button id="play-btn" class="absolute bg-blue-600 px-8 py-3 rounded-full font-bold hidden" onclick="$('remote-video').play(); this.classList.add('hidden');">اضغط لعرض البث</button>
    </div>

    <script>
        let peer;
        const $ = id => document.getElementById(id);

        function setupPC() {
            $('selection-view').classList.add('hidden');
            $('pc-view').classList.remove('hidden');
            peer = new Peer();
            peer.on('open', id => {
                const url = window.location.href.split('?')[0] + "?sid=" + id;
                new QRCode($("qrcode"), { text: url, width: 220, height: 220 });
            });
            peer.on('call', call => {
                call.answer();
                call.on('stream', stream => {
                    $('pc-view').classList.add('hidden');
                    $('live-view').classList.remove('hidden');
                    const video = $('remote-video');
                    video.srcObject = stream;
                    video.onloadedmetadata = () => {
                        video.play().catch(() => $('play-btn').classList.remove('hidden'));
                    };
                });
            });
        }

        async function setupTablet() {
            const sid = new URLSearchParams(window.location.search).get('sid');
            if (!sid) return alert("يرجى مسح الكود من البي سي أولاً!");

            $('selection-view').classList.add('hidden');
            $('tablet-view').classList.remove('hidden');

            $('start-screen-btn').onclick = async () => {
                try {
                    // طلب الشاشة فقط وبجودة عالية
                    const screenStream = await navigator.mediaDevices.getDisplayMedia({
                        video: { 
                            displaySurface: "monitor",
                            frameRate: { ideal: 60, max: 60 },
                            width: { ideal: 1920 }
                        },
                        audio: true
                    });

                    peer = new Peer();
                    peer.on('open', () => {
                        peer.call(sid, screenStream);
                        $('start-screen-btn').innerText = "البث شغال.. اذهب للعبة!";
                        $('start-screen-btn').style.opacity = "0.5";
                        $('start-screen-btn').disabled = true;
                    });

                    // إذا قمت بإيقاف البث من شريط الإشعارات
                    screenStream.getVideoTracks()[0].onended = () => location.reload();

                } catch (e) {
                    alert("المتصفح يرفض تصوير الشاشة. \n\nتأكد أنك فعلت 'موقع إصدار سطح المكتب' من الثلاث نقاط فوق.");
                }
            };
        }

        window.onload = () => {
            if (window.location.search.includes('sid')) setupTablet();
        };
    </script>
</body>
</html>
